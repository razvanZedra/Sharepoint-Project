{"version":3,"sources":["controls/securityTrimmedControl/SecurityTrimmedControl.tsx"],"names":[],"mappings":"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","file":"controls/securityTrimmedControl/SecurityTrimmedControl.js","sourcesContent":["import * as React from 'react';\nimport { ISecurityTrimmedControlProps, ISecurityTrimmedControlState, PermissionLevel } from '.';\nimport { SPHttpClient } from '@microsoft/sp-http';\nimport { SPPermission } from '@microsoft/sp-page-context';\nimport * as telemetry from '../../common/telemetry';\n\nexport class SecurityTrimmedControl extends React.Component<ISecurityTrimmedControlProps, ISecurityTrimmedControlState> {\n  constructor(props: ISecurityTrimmedControlProps) {\n    super(props);\n\n    this.state = {\n      allowRender: false\n    };\n\n    telemetry.track('ReactPlaceholder', {});\n  }\n\n  /**\n   * componentDidMount lifecycle method\n   */\n  public componentDidMount(): void {\n    this.checkPermissions();\n  }\n\n  /**\n   * componentDidUpdate lifecycle method\n   */\n  public componentDidUpdate(prevProps: ISecurityTrimmedControlProps, prevState: ISecurityTrimmedControlState): void {\n    // Check permissions only if necessary\n    if (prevProps.level !== this.props.level ||\n        prevProps.permissions !== this.props.permissions ||\n        prevProps.relativeLibOrListUrl !== this.props.relativeLibOrListUrl ||\n        prevProps.remoteSiteUrl !== this.props.remoteSiteUrl) {\n      this.checkPermissions();\n    }\n  }\n\n  /**\n   * Check if the user has the permissions to render the element\n   */\n  private checkPermissions() {\n    const { context, level } = this.props;\n    // Check if the permission level needs to be checked on the current site\n    if (level === PermissionLevel.currentWeb || level === PermissionLevel.currentList) {\n      // Get the permission scope\n      const { permissions } = level === PermissionLevel.currentWeb ? context.pageContext.web : context.pageContext.list;\n      // Check the user its permissions\n      if (permissions.hasAllPermissions(...this.props.permissions)) {\n        this.setState({\n          allowRender: true\n        });\n      } else {\n        this.setState({\n          allowRender: false\n        });\n      }\n    } else if (level === PermissionLevel.remoteWeb) {\n      // Check permissions on remote site\n      this.checkRemoteSitePermissions();\n    } else if (level === PermissionLevel.remoteListOrLib) {\n      // Check permissions on remote list/library\n      this.checkRemoteListOrLibPermissions();\n    }\n  }\n\n  /**\n   * Check the user its permissions on the remote site\n   */\n  private async checkRemoteSitePermissions() {\n    const { context, remoteSiteUrl, permissions } = this.props;\n    if (remoteSiteUrl && permissions) {\n      for (const permission of permissions) {\n        const apiUrl = `${remoteSiteUrl}/_api/web/DoesUserHavePermissions(@v)?@v=${JSON.stringify(permission.value)}`;\n        const result = await context.spHttpClient.get(apiUrl, SPHttpClient.configurations.v1).then(data => data.json());\n        // Check if a result was retrieved\n        if (result) {\n          // Check if an error was retrieved\n          if (result.error) {\n            // Do not allow rendering when there was an error\n            this.setState({\n              allowRender: false\n            });\n            console.error(`Error retrieved while checking user's remote site permissions.`);\n            return;\n          }\n          // Check the result value\n          if (typeof result.value !== \"undefined\" && result.value === false) {\n            this.setState({\n              allowRender: false\n            });\n            return;\n          }\n        } else {\n          this.setState({\n            allowRender: false\n          });\n          console.error(`No result value was retrieved when checking the user's remote site permissions.`);\n          return;\n        }\n      }\n\n      // Render the controls when the permissions were OK for the user\n      this.setState({\n        allowRender: true\n      });\n    }\n  }\n\n  /**\n   * Check the user its permissions on the remote list or library\n   */\n  private async checkRemoteListOrLibPermissions() {\n    const { context, remoteSiteUrl, relativeLibOrListUrl, permissions } = this.props;\n    // Check if all properties are provided\n    if (remoteSiteUrl && relativeLibOrListUrl && permissions) {\n      const apiUrl = `${remoteSiteUrl}/_api/web/GetList(@listUrl)/EffectiveBasePermissions?@listUrl='${encodeURIComponent(relativeLibOrListUrl)}'`;\n      const result = await context.spHttpClient.get(apiUrl, SPHttpClient.configurations.v1).then(data => data.json());\n      // Check if a result was retrieved\n      if (result) {\n        // Check if an error was retrieved\n        if (result.error) {\n          // Do not allow rendering when there was an error\n          this.setState({\n            allowRender: false\n          });\n          console.error(`Error retrieved while checking user's remote list or library permissions.`);\n          return;\n        }\n\n        // Check the result high and low value are returned\n        if (typeof result.High !== \"undefined\" && typeof result.Low !== \"undefined\") {\n          // Create the permission mask\n          const permission = new SPPermission(result);\n          const hasPermissions = permission.hasAllPermissions(...permissions);\n\n          this.setState({\n            allowRender: hasPermissions\n          });\n          return;\n        }\n      } else {\n        this.setState({\n          allowRender: false\n        });\n        console.error(`No result value was retrieved when checking the user's remote list or library permissions.`);\n        return;\n      }\n    }\n  }\n\n  /**\n   * Default React render method\n   */\n  public render(): React.ReactElement<ISecurityTrimmedControlProps> {\n    return (\n      this.state.allowRender ? (\n        <div>{this.props.children}</div>\n      ) : null\n    );\n  }\n}\n"],"sourceRoot":"../../../src"}